# 핵심 비즈니스 로직 순서도 (Flowchart)

**문서명:** MedAdReview 비즈니스 로직 순서도  
**버전:** 1.0  
**작성일:** 2026년 1월 7일  
**참조 문서:** PRD v1.0, 데이터 모델 명세서 v1.0, API 정의서 v1.0, 기술 스택 가이드 v1.0  

---

## 1. 전체 시스템 흐름도

```
┌───────────────────────────────────────────────────────────────────────────┐
│                       MedAdReview 전체 시스템 흐름                         │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   [광고주] ──▶ [API Gateway] ──▶ [심의요청생성] ──▶ [Queue]              │
│                                                        │                  │
│                                                        ▼                  │
│   ┌─────────────────────────────────────────────────────────────────────┐│
│   │                    AI 심의 에이전트 (LangGraph)                      ││
│   │                                                                     ││
│   │  [청구항추출] ──▶ [위반분류] ──▶ [RAG검색] ──▶ [초안작성]           ││
│   │                                                    │                ││
│   │                          ┌─────────────────────────┘                ││
│   │                          ▼                                          ││
│   │                    [적대적검증]                                      ││
│   │                     │      │                                        ││
│   │                  통과     반려 ──▶ (최대3회 루프)                    ││
│   │                     │                                               ││
│   │                     ▼                                               ││
│   │               [HITL 결정]                                           ││
│   │                │       │                                            ││
│   │           자동완료   인간검토                                        ││
│   └────────────────┼───────┼────────────────────────────────────────────┘│
│                    │       │                                             │
│                    ▼       ▼                                             │
│              [결과저장] ◀── [심의관검토]                                 │
│                    │                                                     │
│                    ▼                                                     │
│              [알림발송] ──▶ [광고주]                                     │
│                                                                          │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 2. LangGraph 에이전트 상세 워크플로우

```
┌───────────────────────────────────────────────────────────────────────────┐
│                        LangGraph 워크플로우 상세                          │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   [START] ──▶ Node 1: 청구항 추출                                        │
│               │                                                           │
│               │  입력: ad_content (광고 원문)                             │
│               │  처리: LLM으로 심의 대상 주장 추출                        │
│               │  출력: extracted_claims[]                                 │
│               │        예: ["100% 완치", "국내 유일"]                     │
│               ▼                                                           │
│          Node 2: 위반유형 분류                                            │
│               │                                                           │
│               │  입력: extracted_claims[]                                 │
│               │  처리: 각 주장을 V1~V6 유형으로 분류                      │
│               │  출력: claim_categories[]                                 │
│               │                                                           │
│               │  ┌────┬───────────────┬─────────────────┐                │
│               │  │ V1 │ 신의료기술    │ 제56조 2항 1호  │                │
│               │  │ V2 │ 치료 경험담   │ 제56조 2항 2호  │                │
│               │  │ V3 │ 거짓/과장    │ 제56조 2항 3호  │                │
│               │  │ V4 │ 비교/비방    │ 제56조 2항 4호  │                │
│               │  │ V5 │ 근거 부재    │ 제56조 2항 7호  │                │
│               │  │ V6 │ 최상급 표현  │ 심의 가이드라인 │                │
│               │  └────┴───────────────┴─────────────────┘                │
│               ▼                                                           │
│          Node 3: 병렬 RAG 검색                                            │
│               │                                                           │
│               │  ┌────────────┬────────────┬────────────┐                │
│               │  │ 법령검색   │ 가이드검색 │ 판례검색   │                │
│               │  │ (Pinecone) │ (Pinecone) │ (Pinecone) │                │
│               │  └─────┬──────┴─────┬──────┴─────┬──────┘                │
│               │        │            │            │                        │
│               │        └────────────┼────────────┘                        │
│               │                     ▼                                     │
│               │               하이브리드 검색                             │
│               │               BM25 + Dense → RRF 융합                     │
│               │                     │                                     │
│               │               Cross-Encoder Reranking                     │
│               ▼                                                           │
│          Node 4: 초안 작성 (Generator)                                    │
│               │                                                           │
│               │  CoT 프롬프트 적용:                                       │
│               │  1. 사실관계 파악                                         │
│               │  2. 법령 적용                                             │
│               │  3. 요건 충족 판단                                        │
│               │  4. 예외 사유 검토                                        │
│               │  5. 결론 도출                                             │
│               │                                                           │
│               │  출력: draft_verdict, draft_reasoning,                   │
│               │        confidence_score, suggestions[]                   │
│               ▼                                                           │
│          Node 5: 적대적 검증 (Evaluator)                                  │
│               │                                                           │
│               │  검증 체크리스트:                                         │
│               │  □ 인용 정확성 (할루시네이션 탐지)                        │
│               │  □ 논리 일관성                                            │
│               │  □ 최신성 검증                                            │
│               │  □ 예외 조항 검토                                         │
│               │  □ 균형성 검토                                            │
│               │                                                           │
│               ├────────┬───────────────────────────────────────────┐     │
│               │        │                                           │     │
│            통과      반려                                          │     │
│               │        │                                           │     │
│               │        ▼                                           │     │
│               │  iteration < 3?                                    │     │
│               │        │                                           │     │
│               │   YES──┴──NO                                       │     │
│               │    │      │                                        │     │
│               │    │      └──────────────────────────────────────▶─│     │
│               │    │                                               │     │
│               │    └──▶ iteration++ ──▶ Node 4로 돌아감            │     │
│               │                                                    │     │
│               ▼                                                    │     │
│          Node 6: HITL 결정                                         │     │
│               │                                                    │     │
│               │  인간 검토 필요 조건:                               │     │
│               │  - confidence_score < 0.8                          │     │
│               │  - verdict == "보류"                               │     │
│               │  - iteration >= 3 (수렴 실패)                      │     │
│               │  - 위반 심각도 "critical"                          │     │
│               │                                                    │     │
│               ├─────────┬─────────────────────────────────────────┘     │
│               │         │                                               │
│          자동완료   인간검토                                             │
│               │         │                                               │
│               │    [INTERRUPT - 대기]                                   │
│               │         │                                               │
│               │    인간 피드백 수신                                      │
│               │         │                                               │
│               │    approve/reject/modify                                │
│               │         │                                               │
│               └────┬────┘                                               │
│                    ▼                                                     │
│          Node 7: 최종 출력 (Finalize)                                    │
│               │                                                          │
│               │  출력: ReviewResult                                      │
│               │  - review_id                                             │
│               │  - verdict (허용/조건부허용/불허/보류)                   │
│               │  - confidence_score                                      │
│               │  - violations[]                                          │
│               │  - reasoning                                             │
│               │  - suggestions[]                                         │
│               ▼                                                          │
│            [END]                                                         │
│                                                                          │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 위반 유형별 탐지 로직

```
┌───────────────────────────────────────────────────────────────────────────┐
│                        위반 유형별 탐지 결정 트리                          │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  [광고 문구 입력]                                                         │
│        │                                                                  │
│        ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ V6: 최상급 표현 탐지                                                 │ │
│  │                                                                      │ │
│  │  "최고", "유일", "최상", "국내 유일" 포함?                           │ │
│  │       │                                                              │ │
│  │  YES──┴──NO                                                          │ │
│  │   │       └──▶ 다음 체크                                             │ │
│  │   ▼                                                                  │ │
│  │  객관적 증빙 있음? ──YES──▶ [허용]                                   │ │
│  │       │                                                              │ │
│  │      NO                                                              │ │
│  │       │                                                              │ │
│  │       ▼                                                              │ │
│  │  [V6 위반: 최상급 표현]                                              │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│        │                                                                  │
│        ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ V3: 거짓/과장 광고 탐지                                              │ │
│  │                                                                      │ │
│  │  "100%", "완치", "보장", "반드시" 포함?                              │ │
│  │       │                                                              │ │
│  │  YES──┴──NO ──▶ 다음 체크                                            │ │
│  │   │                                                                  │ │
│  │   ▼                                                                  │ │
│  │  의학적 검증 가능? ──YES──▶ [조건부허용]                             │ │
│  │       │                                                              │ │
│  │      NO ──▶ [V3 위반: 과장 광고]                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│        │                                                                  │
│        ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ V1: 신의료기술 미평가 탐지                                           │ │
│  │                                                                      │ │
│  │  "줄기세포", "유전자치료", "면역세포" 포함?                          │ │
│  │       │                                                              │ │
│  │  YES──┴──NO ──▶ 다음 체크                                            │ │
│  │   │                                                                  │ │
│  │   ▼                                                                  │ │
│  │  신의료기술 DB 조회 → 평가완료? ──YES──▶ [허용]                      │ │
│  │       │                                                              │ │
│  │      NO ──▶ [V1 위반: 신의료기술 미평가]                             │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│        │                                                                  │
│        ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ V2: 치료 경험담 탐지                                                 │ │
│  │                                                                      │ │
│  │  1인칭 서술 ("제가", "저는", "~했어요") 포함?                        │ │
│  │       │                                                              │ │
│  │  YES──┴──NO ──▶ 다음 체크                                            │ │
│  │   │                                                                  │ │
│  │   ▼                                                                  │ │
│  │  접근제한 플랫폼? ──YES──▶ [허용]                                    │ │
│  │       │                                                              │ │
│  │      NO ──▶ [V2 위반: 치료 경험담]                                   │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│        │                                                                  │
│        ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ V4: 비교/비방 광고 탐지                                              │ │
│  │                                                                      │ │
│  │  경쟁사 언급 + "~보다", "타 병원" 패턴?                              │ │
│  │       │                                                              │ │
│  │  YES──┴──NO ──▶ [허용]                                               │ │
│  │   │                                                                  │ │
│  │   ▼                                                                  │ │
│  │  [V4 위반: 비교/비방 광고]                                           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│        │                                                                  │
│        ▼                                                                  │
│   [최종 위반 목록 생성]                                                   │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 판정 결정 매트릭스

```
┌───────────────────────────────────────────────────────────────────────────┐
│                          최종 판정 결정 매트릭스                           │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  [위반 분석 완료]                                                         │
│        │                                                                  │
│        ▼                                                                  │
│   violation_count == 0?                                                   │
│        │                                                                  │
│   YES──┴──NO                                                              │
│    │       │                                                              │
│    ▼       ▼                                                              │
│ [허용]   심각도 분석                                                      │
│              │                                                            │
│              ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │               심각도별 판정 매트릭스                                  │ │
│  │                                                                      │ │
│  │   ┌──────────┬────────┬────────┬────────┬───────────────┐           │ │
│  │   │ 심각도   │ 1건    │ 2건    │ 3건+   │ 판정 기준     │           │ │
│  │   ├──────────┼────────┼────────┼────────┼───────────────┤           │ │
│  │   │ critical │ 불허   │ 불허   │ 불허   │ 무조건 불허   │           │ │
│  │   │ high     │ 불허   │ 불허   │ 불허   │ 대부분 불허   │           │ │
│  │   │ medium   │ 조건부 │ 불허   │ 불허   │ 건수에 따라   │           │ │
│  │   │ low      │ 조건부 │ 조건부 │ 불허   │ 경고 포함     │           │ │
│  │   └──────────┴────────┴────────┴────────┴───────────────┘           │ │
│  │                                                                      │ │
│  │   복합 심각도 계산:                                                  │ │
│  │   - critical 1건 이상 → 불허                                        │ │
│  │   - high 2건 이상 → 불허                                            │ │
│  │   - medium + high 혼합 → 종합 판단                                  │ │
│  │   - low만 → 조건부허용 (수정 권고)                                   │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│        │                                                                  │
│        ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │               확신도(Confidence) 계산                                 │ │
│  │                                                                      │ │
│  │   confidence = avg(                                                  │ │
│  │       citation_accuracy * 0.30,    // 인용 정확성                    │ │
│  │       logic_consistency * 0.25,    // 논리 일관성                    │ │
│  │       evidence_strength * 0.25,    // 증거 강도                      │ │
│  │       precedent_match * 0.20       // 판례 일치도                    │ │
│  │   )                                                                  │ │
│  │                                                                      │ │
│  │   ┌──────────────┬──────────────────────────────────────┐           │ │
│  │   │ 확신도 구간  │ 처리 방식                             │           │ │
│  │   ├──────────────┼──────────────────────────────────────┤           │ │
│  │   │ 0.95 이상   │ 자동 최종 확정 (HITL 생략 가능)       │           │ │
│  │   │ 0.80~0.95  │ 자동 완료, 샘플링 검토                │           │ │
│  │   │ 0.70~0.80  │ 인간 검토 필수                        │           │ │
│  │   │ 0.70 미만  │ "보류" 판정, 전문가 배정              │           │ │
│  │   └──────────────┴──────────────────────────────────────┘           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│        │                                                                  │
│        ▼                                                                  │
│   [최종 판정 출력]                                                        │
│                                                                           │
│   - 허용: 위반 없음, 광고 게시 가능                                       │
│   - 조건부허용: 경미한 위반, 수정 후 게시 가능                            │
│   - 불허: 명백한 위반, 광고 게시 불가                                     │
│   - 보류: 판단 불가, 전문가 검토 필요                                     │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 5. RAG 하이브리드 검색 프로세스

```
┌───────────────────────────────────────────────────────────────────────────┐
│                        RAG 하이브리드 검색 프로세스                        │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   [검색 쿼리 입력]                                                        │
│        │                                                                  │
│        │  예: "줄기세포 치료 광고 금지 조항"                               │
│        │                                                                  │
│        ▼                                                                  │
│   쿼리 전처리                                                             │
│   (토큰화, 정규화)                                                        │
│        │                                                                  │
│        ├─────────────────────────┬─────────────────────────┐              │
│        │                         │                         │              │
│        ▼                         ▼                         │              │
│   ┌─────────────┐          ┌─────────────┐                 │              │
│   │   BM25      │          │   Dense     │                 │              │
│   │  (Sparse)   │          │  (Vector)   │                 │              │
│   │             │          │             │                 │              │
│   │ 키워드 매칭 │          │ Ko-Legal-   │                 │              │
│   │ 중심       │          │ SBERT 임베딩│                 │              │
│   │             │          │ (768차원)   │                 │              │
│   │ 상위 20개   │          │ 상위 20개   │                 │              │
│   └──────┬──────┘          └──────┬──────┘                 │              │
│          │                        │                         │              │
│          └──────────┬─────────────┘                         │              │
│                     │                                       │              │
│                     ▼                                       │              │
│   ┌─────────────────────────────────────────┐               │              │
│   │         RRF (Reciprocal Rank Fusion)    │               │              │
│   │                                         │               │              │
│   │  공식: RRF(d) = Σ 1/(k + rank_i(d))    │               │              │
│   │        k = 60                           │               │              │
│   │                                         │               │              │
│   │  두 검색 결과 순위 융합                  │               │              │
│   └────────────────┬────────────────────────┘               │              │
│                    │                                        │              │
│                    │  merged_results (상위 15개)            │              │
│                    ▼                                        │              │
│   ┌─────────────────────────────────────────┐               │              │
│   │         Cross-Encoder Reranking         │               │              │
│   │                                         │               │              │
│   │  쿼리-문서 쌍별 정밀 관련성 점수 계산   │               │              │
│   │  최종 순위 재조정                       │               │              │
│   └────────────────┬────────────────────────┘               │              │
│                    │                                        │              │
│                    │  final_results (상위 5개)              │              │
│                    ▼                                        │              │
│              [검색 결과 반환]                                │              │
│                                                             │              │
└─────────────────────────────────────────────────────────────┘              │
```

---

## 6. 인간 피드백 처리 흐름

```
┌───────────────────────────────────────────────────────────────────────────┐
│                          인간 피드백 처리 흐름                             │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   [AI 심의 완료 - 인간 검토 필요]                                         │
│        │                                                                  │
│        ▼                                                                  │
│   심의관 대시보드에 알림                                                  │
│        │                                                                  │
│        ▼                                                                  │
│   심의관 검토 화면                                                        │
│   - 광고 원문                                                             │
│   - AI 판정 결과                                                          │
│   - 위반 사항 목록                                                        │
│   - 추론 과정                                                             │
│   - 인용된 법령                                                           │
│        │                                                                  │
│        ▼                                                                  │
│   ┌──────────────────────────────────────────────────────────────────┐   │
│   │                     심의관 액션 선택                              │   │
│   │                                                                  │   │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐    │   │
│   │  │ approve │  │ reject  │  │ modify  │  │request_revision│    │   │
│   │  │ (승인)  │  │ (기각)  │  │ (수정)  │  │ (수정요청)     │    │   │
│   │  └────┬────┘  └────┬────┘  └────┬────┘  └────────┬────────┘    │   │
│   │       │            │            │                 │             │   │
│   │       │            │            │                 │             │   │
│   │       ▼            ▼            ▼                 ▼             │   │
│   │  AI 판정       AI 판정       수정사항        광고주에게        │   │
│   │  그대로 확정   기각하고      적용 후        수정 요청         │   │
│   │               재판정        확정           발송              │   │
│   └──────┬────────────┬────────────┬────────────────┬────────────┘   │
│          │            │            │                │                 │
│          └────────────┴────────────┴────────────────┘                 │
│                            │                                          │
│                            ▼                                          │
│                    [최종 결과 확정]                                    │
│                            │                                          │
│                            ▼                                          │
│                    - final_verdict 저장                               │
│                    - finalized_at 기록                                │
│                    - human_reviewed = true                            │
│                            │                                          │
│                            ▼                                          │
│                    [광고주에게 결과 통보]                              │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

---

**문서 끝**
